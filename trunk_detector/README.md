# ROS trunk_detector
Пакет содержит детектор препятсвий, реализующий метод разделения облака точек на слои и установления взаимосвязей между точками разных слоев.
Основной узел-детектор `trunk_detector_node` выполняет обнаружение по постутающим данным с 3D-лидара и публикует массив обнаруженных препятсвий в виде сообщенний `TrunkPoseArray` из пакета `trunk_detector_msgs`.
Также имеется вспомогательный узел `trunk_visualizator_node` для визуализации обнаруженных препятствий средствами Point Cloud Library.

Работа детектора происходит в паре с плагином `TrunkDetectorUpdater` для построителя карты `rolling_map`.
Для плагина рекомендуемые значения коэффициентов доверия по классам составляют `0.00, 0.60, 0.80, 0.90`:
* класс 1 ("ровная поверхность") используется для "заливки" точек, соответствующих первому слою
* класс 2 ("неровность") используется в основном для маркировки тех ячеек карты, где когда-то было обнаружено препятствие, но на текущий момент информации о его присутствии в этой ячейке нет
* класс 3 ("серьезная неровность") соответствует препятствиям, высота которых больше значения, задаваемого параметром `small_trunk_hight`, но не преввышает `medium_trunk_hight`
* класс 4 ("препятствие") соответствует препятствиям, высота которых больше значения, задаваемого параметром `medium_trunk_hight`

Каждому обнаруженному препятствию назначается "врямя жизни", по истечению которого, если информация о препятствии в данной ячейке не будет получена повторно, препятствие переводится в статус неактивных (класс 2).
При повторном получении данных о препятствии в данной ячейке его "время жизни" сбрасывается.

# Используемые классы
Объект класса _TrunkDetector_ реализует основной цикл работы узла.
В конструкторе происходит чтение ROS-параметров, инициализация издатей и подписчиков для используемых тем.
В функции-обработчике входящих сообщений происходит преобразование поступающих данных в формат PCL и обработка данных об обнаруженных препятствиях для их публикации.
Объект класса _TrunkFinder_ (обнаружитель) выполняет обработку данных в формате PCL и формирует данные об обнаруженных препятствиях.

## Зависимости
Для сборки и запуска `trunk_detector_node` необходимы **PCL** и следующие ROS-пакеты:
* roscpp
* sensor_msgs
* pcl_ros
* pcl_conversions
* trunk_detector_msgs

## Темы для сбора информации
Указаны используемые по умолчанию названия тем, в скобках приведен тип сообщения:
* /velodyne_points (sensor_msgs/PointCloud2) - облако точек от лидара


## Темы для публикации информации
Указаны используемые по умолчанию названия тем, в скобках приведен тип сообщения:
* /trunk_detector_node/detector_output (trunk_detector_msgs/TrunkPoseArray) - результат обнаружения в виде массива препятствий

## Параметры ROS
Параметры обнаружителя, в скобках указано значение по умолчанию:
* float `v_shift` (1.9) - высота лидара над уровнем земли
* float `v_delta` (0.75) - высота одного слоя облака точек
* float `cluster_tolerance` (0.9) - допуск при кластеризации
* int `cluster_max_size` (200) - максимальное число точек в кластере
* int `cluster_min_size` (1) - минимальное число точек в кластере
* float `max_angle_deg` (40.0) - максимально допустимое отклонение препятствий от вертикали в градусах
* int `slices_number` (4) - число слоев облака точек
* float `empty_radius` (5.0) - радиус мертвой зоны вблизи лидара

Параметры узла-детектора:
* float `small_trunk_hight` (0.5) - предельная высота "малых" препятствий в метрах
* float `medium_trunk_hight` (1.5) - предельная высота "средних" препятствий в метрах
* float `map_size` (90.0) - радиус области видимости в метрах
* float `cell_size` (0.2) - размер ячейки сетки в метрах
* float `update_rate` (10.0) - предельная частота обновления данных
* string `input_pointclouds_topic` ("/normalized_points") - название темы с данными лидара
* string `output_pointclouds_topic` ("detector_input") - название темы выходных данных

## Конфигурационные файлы
Пакет содержит два файла параметров:
* `logging_level.cfg` - задает уровень (ERROR, WARN, INFO, DEBUG) выводимых в консоль сообщений
* `trunk_detector_param.cfg` - содержит список параметров ROS с заданными значениями

## Запуск
Пакет содержит launch-файл для запуска основного узла `run_trunk_detector_node.launch`.
Запуск узла:
``` bash
roslaunch trunk_detector run_trunk_detector_node.launch
```
